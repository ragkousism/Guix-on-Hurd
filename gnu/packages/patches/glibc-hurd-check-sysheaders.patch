With this patch glibc takes into account the '--with-headers' argument.

From 39b09d8cb8ee3b3ca0ca9fcd772df3fab41c02f8 Mon Sep 17 00:00:00 2001
From: Manolis Ragkousis <manolis837@gmail.com>
Date: Fri, 14 Aug 2015 01:20:59 +0300
Subject: [PATCH] Check sysheaders when looking for Mach and Hurd headers.

* sysdeps/mach/configure.ac: Add sysheaders check.
* sysdeps/mach/configure: Regenerate.
* sysdeps/mach/hurd/configure.ac: Add sysheaders check.
* sysdeps/mach/hurd/configure: Regenerate.
---
 sysdeps/mach/configure         | 9 +++++++++
 sysdeps/mach/configure.ac      | 9 +++++++++
 sysdeps/mach/hurd/configure    | 9 +++++++++
 sysdeps/mach/hurd/configure.ac | 9 +++++++++
 4 files changed, 36 insertions(+)

diff --git a/sysdeps/mach/configure b/sysdeps/mach/configure
index 290a5ff..d7c102c 100644
--- a/sysdeps/mach/configure
+++ b/sysdeps/mach/configure
@@ -165,6 +165,11 @@ fi
 config_vars="$config_vars
 MIG = $MIG"
 
+if test -n "$sysheaders"; then
+  OLD_CPPFLAGS=$CPPFLAGS
+  CPPFLAGS="$CPPFLAGS $SYSINCLUDES"
+fi
+
 ### Sanity checks for Mach header installation
 
 
@@ -553,3 +558,7 @@ if test $hurd_cv_mig_retcode = yes; then
   $as_echo "#define HAVE_MIG_RETCODE 1" >>confdefs.h
 
 fi
+
+if test -n "$sysheaders"; then
+  CPPFLAGS=$OLD_CPPFLAGS
+fi
diff --git a/sysdeps/mach/configure.ac b/sysdeps/mach/configure.ac
index 52d47e0..f972270 100644
--- a/sysdeps/mach/configure.ac
+++ b/sysdeps/mach/configure.ac
@@ -6,6 +6,11 @@ if test "x$MIG" = xMISSING; then
 fi
 LIBC_CONFIG_VAR([MIG], [$MIG])
 
+if test -n "$sysheaders"; then
+  OLD_CPPFLAGS=$CPPFLAGS
+  CPPFLAGS="$CPPFLAGS $SYSINCLUDES"
+fi
+
 ### Sanity checks for Mach header installation
 AC_CHECK_HEADER(mach/mach_types.h,,
                 [AC_MSG_ERROR([cannot find Mach headers])], -)
@@ -124,3 +129,7 @@ if test $hurd_cv_mig_retcode = yes; then
 fi])
 
 hurd_MIG_RETCODE
+
+if test -n "$sysheaders"; then
+  CPPFLAGS=$OLD_CPPFLAGS
+fi
diff --git a/sysdeps/mach/hurd/configure b/sysdeps/mach/hurd/configure
index a0f9721..4b2ad37 100644
--- a/sysdeps/mach/hurd/configure
+++ b/sysdeps/mach/hurd/configure
@@ -17,6 +17,11 @@ case "$machine" in
     ;;
 esac
 
+if test -n "$sysheaders"; then
+  OLD_CPPFLAGS=$CPPFLAGS
+  CPPFLAGS="$CPPFLAGS $SYSINCLUDES"
+fi
+
 
 { $as_echo "$as_me:${as_lineno-$LINENO}: checking Hurd header version" >&5
 $as_echo_n "checking Hurd header version... " >&6; }
@@ -50,3 +55,7 @@ $as_echo "$libc_cv_hurd_version" >&6; }
 if test "x$libc_cv_hurd_version" != xok; then
   as_fn_error $? "Hurd headers not installed or too old" "$LINENO" 5
 fi
+
+if test -n "$sysheaders"; then
+  CPPFLAGS=$OLD_CPPFLAGS
+fi
diff --git a/sysdeps/mach/hurd/configure.ac b/sysdeps/mach/hurd/configure.ac
index ad915a5..db783a0 100644
--- a/sysdeps/mach/hurd/configure.ac
+++ b/sysdeps/mach/hurd/configure.ac
@@ -17,6 +17,11 @@ case "$machine" in
     ;;
 esac
 
+if test -n "$sysheaders"; then
+  OLD_CPPFLAGS=$CPPFLAGS
+  CPPFLAGS="$CPPFLAGS $SYSINCLUDES"
+fi
+
 AC_CACHE_CHECK(Hurd header version, libc_cv_hurd_version, [dnl
 AC_TRY_COMPILE(dnl
 [#include <hurd/version.h>], [
@@ -29,3 +34,7 @@ AC_TRY_COMPILE(dnl
 if test "x$libc_cv_hurd_version" != xok; then
   AC_MSG_ERROR(Hurd headers not installed or too old)
 fi
+
+if test -n "$sysheaders"; then
+  CPPFLAGS=$OLD_CPPFLAGS
+fi
-- 
2.5.0

